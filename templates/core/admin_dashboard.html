{% extends 'core/base_dashboard.html' %}

{% block title %}Admin Dashboard - EcoDrop{% endblock %}
{% block page_title %}Admin Overview{% endblock %}

{% block sidebar %}
<div class="nav-section">
    <div class="nav-label">Administration</div>
    <ul class="nav-list">
        <li class="nav-item">
            <a href="{% url 'admin_dashboard' %}" class="active">
                <i class="fas fa-chart-line"></i> Overview
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_users' %}">
                <i class="fas fa-users"></i> Users
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_devices' %}">
                <i class="fas fa-microchip"></i> Devices
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_rewards' %}">
                <i class="fas fa-gift"></i> Rewards
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_transactions' %}">
                <i class="fas fa-exchange-alt"></i> Transactions
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_redemptions' %}">
                <i class="fas fa-history"></i> Redemptions
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_device_logs' %}">
                <i class="fas fa-clipboard-list"></i> System Logs
            </a>
        </li>
    </ul>
</div>

<div class="nav-section">
    <div class="nav-label">System</div>
    <ul class="nav-list">
        <li class="nav-item">
            <a href="{% url 'admin_settings' %}">
                <i class="fas fa-cog"></i> Settings
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_full_panel' %}">
                <i class="fas fa-sliders-h"></i> Advanced Panel
            </a>
        </li>
    </ul>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    .welcome-card {
        background: linear-gradient(135deg, var(--primary) 0%, #6366f1 100%);
        color: white;
        border: none;
        padding: 32px;
        position: relative;
        overflow: hidden;
    }

    .welcome-card::after {
        content: '';
        position: absolute;
        top: -50px;
        right: -50px;
        width: 150px;
        height: 150px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-card {
        padding: 24px;
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
    }

    .stat-info .value {
        font-size: 1.5rem;
        font-weight: 700;
        line-height: 1;
        margin-bottom: 4px;
        display: block;
    }

    .stat-info .label {
        font-size: 13px;
        color: var(--text-muted);
        font-weight: 500;
    }

    .bg-blue-light { background: #eff6ff; color: #3b82f6; }
    .bg-green-light { background: #f0fdf4; color: #22c55e; }
    .bg-purple-light { background: #faf5ff; color: #a855f7; }
    .bg-yellow-light { background: #fffbeb; color: #f59e0b; }

    /* Tables */
    .table-container {
        overflow-x: auto;
    }

    .custom-table {
        width: 100%;
        border-collapse: collapse;
    }

    .custom-table th {
        text-align: left;
        padding: 12px 16px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-muted);
        border-bottom: 1px solid var(--border-color);
        background: #fafafa;
    }

    .custom-table td {
        padding: 16px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
    }

    .custom-table tr:last-child td {
        border-bottom: none;
    }

    .custom-table tr:hover {
        background: #fcfcfc;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
    }

    .badge-success { background: #dcfce7; color: #166534; }
    .badge-error { background: #fee2e2; color: #991b1b; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-info { background: #e0f2fe; color: #075985; }

    /* Section Header */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .section-title {
        font-size: 1rem;
        font-weight: 600;
    }

    .btn-outline {
        padding: 8px 14px;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: white;
        color: var(--text-main);
        text-decoration: none;
        font-size: 13px;
        font-weight: 500;
        transition: all 0.2s;
    }

    .btn-outline:hover {
        background: var(--bg-main);
        border-color: #cbd5e1;
    }
</style>
{% endblock %}

{% block content %}
<div class="card welcome-card">
    <h1 style="font-size: 1.5rem; margin-bottom: 8px;">Admin Dashboard</h1>
    <p style="opacity: 0.9;">System overview: Manage users, monitor devices, and track recycling progress.</p>
</div>

<!-- Statistics Grid -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon bg-blue-light">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ total_users }}</span>
            <span class="label">Total Users</span>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon bg-green-light">
            <i class="fas fa-recycle"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ total_bottles }}</span>
            <span class="label">Bottles Recycled</span>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon bg-purple-light">
            <i class="fas fa-microchip"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ total_devices|default:0 }}</span>
            <span class="label">Active Devices</span>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon bg-yellow-light">
            <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ recent_deposits|default:0 }}</span>
            <span class="label">Weekly Deposits</span>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Recent Device Activity -->
    <div>
        <div class="section-header">
            <h2 class="section-title">Recent Device Activity</h2>
            <a href="{% url 'admin_device_logs' %}" class="btn-outline">View All Logs</a>
        </div>
        <div class="card" style="padding: 0;">
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Device</th>
                            <th>Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_device_logs %}
                            {% for log in recent_device_logs %}
                            <tr>
                                <td style="color: var(--text-muted);">{{ log.created_at|date:"H:i" }}</td>
                                <td style="font-weight: 500;">{{ log.device.device_name }}</td>
                                <td>{{ log.get_log_type_display|default:log.log_type|title }}</td>
                                <td>
                                    {% if log.sort_result == 'plastic' %}
                                        <span class="badge badge-success">Valid Plastic</span>
                                    {% elif log.sort_result == 'invalid' %}
                                        <span class="badge badge-error">Invalid</span>
                                    {% else %}
                                        <span class="badge badge-info">{{ log.sort_result|default:"OK"|title }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">No recent activity</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Top Recyclers -->
    <div>
        <div class="section-header">
            <h2 class="section-title">Top Recyclers</h2>
            <a href="{% url 'admin_users' %}" class="btn-outline">More</a>
        </div>
        <div class="card" style="padding: 0;">
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if top_recyclers %}
                            {% for profile in top_recyclers %}
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">
                                            {{ profile.user.username|first|upper }}
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 500;">{{ profile.user.get_full_name|default:profile.user.username }}</span>
                                            <span style="font-size: 11px; color: var(--text-muted);">{{ profile.user_type|title }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td><span style="color: var(--primary); font-weight: 700;">{{ profile.total_points }}</span></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: var(--text-muted);">No users found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Device Performance -->
<div>
    <div class="section-header">
        <h2 class="section-title">Device Fleet Performance</h2>
        <a href="{% url 'admin_devices' %}" class="btn-outline">Manage Devices</a>
    </div>
    <div class="card" style="padding: 0;">
        <div class="table-container">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Device Name</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Total Bottles</th>
                        <th>7d Activity</th>
                        <th>Last Heartbeat</th>
                    </tr>
                </thead>
                <tbody>
                    {% if device_performance %}
                        {% for device in device_performance %}
                        <tr>
                            <td style="font-weight: 600;">{{ device.device_name }}</td>
                            <td>{{ device.location }}</td>
                            <td>
                                {% if device.status == 'online' %}
                                    <span class="badge badge-success">Online</span>
                                {% elif device.status == 'offline' %}
                                    <span class="badge badge-error">Offline</span>
                                {% else %}
                                    <span class="badge badge-warning">{{ device.status|title }}</span>
                                {% endif %}
                            </td>
                            <td><span style="font-weight: 500;">{{ device.total_bottles_processed }}</span></td>
                            <td>{{ device.recent_bottles }}</td>
                            <td style="color: var(--text-muted);">{{ device.last_heartbeat|date:"M d, H:i"|default:"从来" }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No devices registered</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

