{% extends 'core/base_dashboard.html' %}
{% load static %}

{% block title %}Admin Dashboard - EcoDrop{% endblock %}
{% block page_title %}Admin Overview{% endblock %}

{% block sidebar %}
    {% include 'core/includes/admin_sidebar.html' %}
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'core/css/admin_dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="card welcome-card">
    <h1 style="font-size: 1.5rem; margin-bottom: 8px;">Admin Dashboard</h1>
    <p style="opacity: 0.9;">System overview: Manage users, monitor devices, and track recycling progress.</p>
</div>

<!-- Statistics Grid -->
<div class="stats-grid">
    <div class="card stat-card">
        <div class="stat-icon bg-blue-light">
            <i class="fas fa-users"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ total_users }}</span>
            <span class="label">Total Users</span>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon bg-green-light">
            <i class="fas fa-recycle"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ total_bottles }}</span>
            <span class="label">Bottles Recycled</span>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon bg-purple-light">
            <i class="fas fa-microchip"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ total_devices|default:0 }}</span>
            <span class="label">Active Devices</span>
        </div>
    </div>
    <div class="card stat-card">
        <div class="stat-icon bg-yellow-light">
            <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="stat-info">
            <span class="value">{{ recent_deposits|default:0 }}</span>
            <span class="label">Weekly Deposits</span>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
    <!-- Recent Device Activity -->
    <div>
        <div class="section-header">
            <h2 class="section-title">Recent Device Activity</h2>
            <a href="{% url 'admin_device_logs' %}" class="btn-outline">View All Logs</a>
        </div>
        <div class="card" style="padding: 0;">
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Device</th>
                            <th>Activity</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if recent_device_logs %}
                            {% for log in recent_device_logs %}
                            <tr>
                                <td style="color: var(--text-muted);">{{ log.created_at|date:"H:i" }}</td>
                                <td style="font-weight: 500;">{{ log.device.device_name }}</td>
                                <td>{{ log.get_log_type_display|default:log.log_type|title }}</td>
                                <td>
                                    {% if log.sort_result == 'plastic' %}
                                        <span class="badge badge-success">Valid Plastic</span>
                                    {% elif log.sort_result == 'invalid' %}
                                        <span class="badge badge-error">Invalid</span>
                                    {% else %}
                                        <span class="badge badge-info">{{ log.sort_result|default:"OK"|title }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-muted);">No recent activity</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Top Recyclers -->
    <div>
        <div class="section-header">
            <h2 class="section-title">Top Recyclers</h2>
            <a href="{% url 'admin_users' %}" class="btn-outline">More</a>
        </div>
        <div class="card" style="padding: 0;">
            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if top_recyclers %}
                            {% for profile in top_recyclers %}
                            <tr>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <div style="width: 28px; height: 28px; border-radius: 50%; background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600;">
                                            {{ profile.user.username|first|upper }}
                                        </div>
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-weight: 500;">{{ profile.user.get_full_name|default:profile.user.username }}</span>
                                            <span style="font-size: 11px; color: var(--text-muted);">{{ profile.user_type|title }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td><span style="color: var(--primary); font-weight: 700;">{{ profile.total_points }}</span></td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: var(--text-muted);">No users found</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Device Performance -->
<div>
    <div class="section-header">
        <h2 class="section-title">Device Fleet Performance</h2>
        <a href="{% url 'admin_devices' %}" class="btn-outline">Manage Devices</a>
    </div>
    <div class="card" style="padding: 0;">
        <div class="table-container">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th>Device Name</th>
                        <th>Location</th>
                        <th>Status</th>
                        <th>Total Bottles</th>
                        <th>7d Activity</th>
                        <th>Last Heartbeat</th>
                    </tr>
                </thead>
                <tbody>
                    {% if device_performance %}
                        {% for device in device_performance %}
                        <tr>
                            <td style="font-weight: 600;">{{ device.device_name }}</td>
                            <td>{{ device.location }}</td>
                            <td>
                                {% if device.status == 'online' %}
                                    <span class="badge badge-success">Online</span>
                                {% elif device.status == 'offline' %}
                                    <span class="badge badge-error">Offline</span>
                                {% else %}
                                    <span class="badge badge-warning">{{ device.status|title }}</span>
                                {% endif %}
                            </td>
                            <td><span style="font-weight: 500;">{{ device.total_bottles_processed }}</span></td>
                            <td>{{ device.recent_bottles }}</td>
                            <td style="color: var(--text-muted);">{{ device.last_heartbeat|date:"M d, H:i"|default:"从来" }}</td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-muted);">No devices registered</td>
                        </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

