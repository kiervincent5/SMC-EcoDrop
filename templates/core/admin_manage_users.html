{% extends 'core/base_dashboard.html' %}
{% load static %}

{% block title %}User Management - Admin Console{% endblock %}
{% block page_title %}Network Directory{% endblock %}

{% block sidebar %}
    {% include 'core/includes/admin_sidebar.html' %}
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'core/css/admin_tables.css' %}">
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-mini-card">
        <div class="stat-icon-wrapper" style="background: #eef2ff; color: #4f46e5;">
            <i class="fas fa-users"></i>
        </div>
        <div>
            <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Total Accounts</p>
            <h3 style="font-size: 24px; font-weight: 700;">{{ users.count }}</h3>
        </div>
    </div>
    <div class="stat-mini-card">
        <div class="stat-icon-wrapper" style="background: #ecfdf5; color: #059669;">
            <i class="fas fa-user-graduate"></i>
        </div>
        <div>
            <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Active Students</p>
            <h3 style="font-size: 24px; font-weight: 700;">{{ student_count|default:"---" }}</h3>
        </div>
    </div>
    <div class="stat-mini-card">
        <div class="stat-icon-wrapper" style="background: #fff7ed; color: #ea580c;">
            <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div>
            <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Faculty & Staff</p>
            <h3 style="font-size: 24px; font-weight: 700;">{{ faculty_count|default:"---" }}</h3>
        </div>
    </div>
</div>

<div class="action-bar">
    <div class="search-input-group">
        <i class="fas fa-search"></i>
        <input type="text" id="userSearch" class="form-control-listing" placeholder="Identify users by name, id, or email...">
    </div>
    <div class="filter-controls">
        <select id="roleFilter" class="select-control-listing">
            <option value="all">Every Role</option>
            <option value="student">Students</option>
            <option value="staff">Faculty/Staff</option>
            <option value="admin">Administrators</option>
        </select>
        <select id="pageSize" class="select-control-listing" style="min-width: 100px;">
            <option value="10">10 Rows</option>
            <option value="25" selected>25 Rows</option>
            <option value="50">50 Rows</option>
        </select>
        <a href="{% url 'admin_user_add' %}" class="btn-primary" style="padding: 10px 20px; border-radius: 12px; text-decoration: none; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; background: var(--primary); color: white;">
            <i class="fas fa-plus"></i> Add User
        </a>
    </div>
</div>

<div class="table-container">
    <div class="table-responsive">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 350px;">Personnel</th>
                    <th>Institutional ID</th>
                    <th>Engagement (Points)</th>
                    <th>Classification</th>
                    <th style="text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody id="usersBody">
                {% for u in users %}
                <tr class="user-row" 
                    data-search="{{ u.get_full_name|lower }} {{ u.username|lower }} {{ u.profile.school_id|lower }} {{ u.email|lower }}"
                    data-role="{% if u.is_superuser %}admin{% elif u.is_staff %}staff{% else %}student{% endif %}">
                    <td>
                        <div class="identity-cell">
                            <div class="avatar-circle">
                                {{ u.first_name|default:u.username|first|upper }}
                            </div>
                            <div class="user-meta">
                                <h4>{{ u.get_full_name|default:u.username }}</h4>
                                <p>@{{ u.username }}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600; color: #475569;">
                            {{ u.profile.school_id|default:"---" }}
                        </span>
                    </td>
                    <td>
                        <div class="points-tag">
                            <i class="fas fa-leaf"></i>
                            {{ u.profile.total_points|default:0 }}
                        </div>
                    </td>
                    <td>
                        {% if u.is_superuser %}
                            <span class="role-badge role-admin">
                                <i class="fas fa-shield-alt"></i> Admin
                            </span>
                        {% elif u.is_staff %}
                            <span class="role-badge role-faculty">
                                <i class="fas fa-graduation-cap"></i> Faculty
                            </span>
                        {% else %}
                            <span class="role-badge role-student">
                                <i class="fas fa-user"></i> Student
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; justify-content: flex-end;">
                            <a href="{% url 'admin_user_edit' u.id %}" class="btn-action" title="Edit Profile">
                                <i class="fas fa-cog"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="table-footer">
        <p style="font-size: 13px; color: var(--text-muted);" id="paginationInfo">
            Displaying entries...
        </p>
        <div class="pagination" id="pagination">
            <!-- Dynamic Buttons -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('userSearch');
        const roleFilter = document.getElementById('roleFilter');
        const pageSizeSelect = document.getElementById('pageSize');
        const userRows = Array.from(document.querySelectorAll('.user-row'));
        const paginationContainer = document.getElementById('pagination');
        const paginationInfo = document.getElementById('paginationInfo');
        
        let currentPage = 1;
        let filteredRows = [...userRows];

        function updateTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRole = roleFilter.value;
            const pageSize = parseInt(pageSizeSelect.value);

            filteredRows = userRows.filter(row => {
                const searchMatch = row.getAttribute('data-search').includes(searchTerm);
                const roleMatch = selectedRole === 'all' || row.getAttribute('data-role') === selectedRole;
                return searchMatch && roleMatch;
            });

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;

            userRows.forEach(row => row.style.display = 'none');
            filteredRows.slice(startIdx, endIdx).forEach(row => row.style.display = '');

            updatePagination(totalPages, startIdx, endIdx);
        }

        function updatePagination(totalPages, start, end) {
            paginationContainer.innerHTML = '';
            
            const createBtn = (label, page, active = false, disabled = false) => {
                const btn = document.createElement('button');
                btn.className = `page-btn ${active ? 'active' : ''}`;
                btn.textContent = label;
                btn.disabled = disabled;
                btn.addEventListener('click', () => {
                    currentPage = page;
                    updateTable();
                });
                return btn;
            };

            paginationContainer.appendChild(createBtn('«', currentPage - 1, false, currentPage === 1));
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationContainer.appendChild(createBtn(i, i, i === currentPage));
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.style.padding = '8px';
                    paginationContainer.appendChild(span);
                }
            }

            paginationContainer.appendChild(createBtn('»', currentPage + 1, false, currentPage === totalPages || totalPages === 0));

            const totalShown = Math.min(end, filteredRows.length);
            paginationInfo.textContent = filteredRows.length > 0 
                ? `Showing ${start + 1} to ${totalShown} of ${filteredRows.length} users`
                : `No users found`;
        }

        searchInput.addEventListener('input', () => { currentPage = 1; updateTable(); });
        roleFilter.addEventListener('change', () => { currentPage = 1; updateTable(); });
        pageSizeSelect.addEventListener('change', () => { currentPage = 1; updateTable(); });

        updateTable();
    });
</script>
{% endblock %}


