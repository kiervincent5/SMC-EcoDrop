{% extends 'core/base_dashboard.html' %}

{% block title %}User Management - Admin Console{% endblock %}
{% block page_title %}Network Directory{% endblock %}

{% block sidebar %}
<div class="nav-section">
    <div class="nav-label">Administration</div>
    <ul class="nav-list">
        <li class="nav-item">
            <a href="{% url 'admin_dashboard' %}">
                <i class="fas fa-chart-line"></i> Overview
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_users' %}" class="active">
                <i class="fas fa-users"></i> Users
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_devices' %}">
                <i class="fas fa-microchip"></i> Devices
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_rewards' %}">
                <i class="fas fa-gift"></i> Rewards
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_transactions' %}">
                <i class="fas fa-exchange-alt"></i> Transactions
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_redemptions' %}">
                <i class="fas fa-history"></i> Redemptions
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_device_logs' %}">
                <i class="fas fa-clipboard-list"></i> System Logs
            </a>
        </li>
    </ul>
</div>

<div class="nav-section">
    <div class="nav-label">System</div>
    <ul class="nav-list">
        <li class="nav-item">
            <a href="{% url 'admin_settings' %}">
                <i class="fas fa-cog"></i> Settings
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'admin_full_panel' %}">
                <i class="fas fa-sliders-h"></i> Advanced Panel
            </a>
        </li>
    </ul>
</div>
{% endblock %}

{% block extra_styles %}
<style>
    /* Stats Row */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .stat-mini-card {
        background: white;
        padding: 24px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 20px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-mini-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }

    .stat-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    /* Filter Aesthetic */
    .action-bar {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(8px);
        padding: 24px;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .search-input-group {
        position: relative;
        flex: 1;
        max-width: 400px;
    }

    .search-input-group i {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    .form-control {
        width: 100%;
        padding: 12px 16px 12px 42px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        font-size: 14px;
        background: white;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.08);
    }

    .filter-controls {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .select-control {
        padding: 10px 14px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        background: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        min-width: 150px;
    }

    /* Premium Table */
    .table-container {
        background: white;
        border-radius: 16px;
        border: 1px solid var(--border-color);
        overflow: hidden;
        box-shadow: var(--shadow);
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: #f8fafc;
        padding: 16px 24px;
        text-align: left;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #64748b;
        border-bottom: 1px solid var(--border-color);
    }

    .data-table td {
        padding: 18px 24px;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        vertical-align: middle;
    }

    .data-table tbody tr {
        transition: all 0.2s;
    }

    .data-table tbody tr:hover {
        background: #f1f5f9;
        transform: scale(1.002);
    }

    .identity-cell {
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .avatar-circle {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: var(--primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 16px;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }

    .user-meta h4 {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-main);
        margin: 0;
    }

    .user-meta p {
        font-size: 12px;
        color: var(--text-muted);
        margin: 2px 0 0;
    }

    .points-tag {
        background: #ecfdf5;
        color: #059669;
        padding: 6px 12px;
        border-radius: 8px;
        font-weight: 700;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .role-badge {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .role-student { background: #eff6ff; color: #1e40af; }
    .role-faculty { background: #fff7ed; color: #c2410c; }
    .role-admin { background: #fdf2f8; color: #be185d; }

    .btn-action {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        text-decoration: none;
        transition: all 0.2s;
        border: 1px solid var(--border-color);
    }

    .btn-action:hover {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
        transform: rotate(15deg);
    }

    /* Footer Pagination */
    .table-footer {
        padding: 20px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid var(--border-color);
        background: #f8fafc;
    }

    .pagination {
        display: flex;
        gap: 8px;
    }

    .page-btn {
        padding: 8px 16px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background: white;
        color: var(--text-main);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .page-btn:hover:not(:disabled) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .page-btn.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-grid">
    <div class="stat-mini-card">
        <div class="stat-icon-wrapper" style="background: #eef2ff; color: #4f46e5;">
            <i class="fas fa-users"></i>
        </div>
        <div>
            <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Total Accounts</p>
            <h3 style="font-size: 24px; font-weight: 700;">{{ users.count }}</h3>
        </div>
    </div>
    <div class="stat-mini-card">
        <div class="stat-icon-wrapper" style="background: #ecfdf5; color: #059669;">
            <i class="fas fa-user-graduate"></i>
        </div>
        <div>
            <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Active Students</p>
            <h3 style="font-size: 24px; font-weight: 700;">{{ student_count|default:"---" }}</h3>
        </div>
    </div>
    <div class="stat-mini-card">
        <div class="stat-icon-wrapper" style="background: #fff7ed; color: #ea580c;">
            <i class="fas fa-chalkboard-teacher"></i>
        </div>
        <div>
            <p style="font-size: 13px; color: var(--text-muted); font-weight: 500;">Faculty & Staff</p>
            <h3 style="font-size: 24px; font-weight: 700;">{{ faculty_count|default:"---" }}</h3>
        </div>
    </div>
</div>

<div class="action-bar">
    <div class="search-input-group">
        <i class="fas fa-search"></i>
        <input type="text" id="userSearch" class="form-control" placeholder="Identify users by name, id, or email...">
    </div>
    <div class="filter-controls">
        <select id="roleFilter" class="select-control">
            <option value="all">Every Role</option>
            <option value="student">Students</option>
            <option value="staff">Faculty/Staff</option>
            <option value="admin">Administrators</option>
        </select>
        <select id="pageSize" class="select-control" style="min-width: 100px;">
            <option value="10">10 Rows</option>
            <option value="25" selected>25 Rows</option>
            <option value="50">50 Rows</option>
        </select>
        <a href="{% url 'admin_user_add' %}" class="btn-primary" style="padding: 10px 20px; border-radius: 12px; text-decoration: none; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; background: var(--primary); color: white;">
            <i class="fas fa-plus"></i> Add User
        </a>
    </div>
</div>

<div class="table-container">
    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 350px;">Personnel</th>
                    <th>Institutional ID</th>
                    <th>Engagement (Points)</th>
                    <th>Classification</th>
                    <th style="text-align: right;">Action</th>
                </tr>
            </thead>
            <tbody id="usersBody">
                {% for u in users %}
                <tr class="user-row" 
                    data-search="{{ u.get_full_name|lower }} {{ u.username|lower }} {{ u.profile.school_id|lower }} {{ u.email|lower }}"
                    data-role="{% if u.is_superuser %}admin{% elif u.is_staff %}staff{% else %}student{% endif %}">
                    <td>
                        <div class="identity-cell">
                            <div class="avatar-circle">
                                {{ u.first_name|default:u.username|first|upper }}
                            </div>
                            <div class="user-meta">
                                <h4>{{ u.get_full_name|default:u.username }}</h4>
                                <p>@{{ u.username }}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="font-family: monospace; font-weight: 600; color: #475569;">
                            {{ u.profile.school_id|default:"---" }}
                        </span>
                    </td>
                    <td>
                        <div class="points-tag">
                            <i class="fas fa-leaf"></i>
                            {{ u.profile.total_points|default:0 }}
                        </div>
                    </td>
                    <td>
                        {% if u.is_superuser %}
                            <span class="role-badge role-admin">
                                <i class="fas fa-shield-alt"></i> Admin
                            </span>
                        {% elif u.is_staff %}
                            <span class="role-badge role-faculty">
                                <i class="fas fa-graduation-cap"></i> Faculty
                            </span>
                        {% else %}
                            <span class="role-badge role-student">
                                <i class="fas fa-user"></i> Student
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; justify-content: flex-end;">
                            <a href="{% url 'admin_user_edit' u.id %}" class="btn-action" title="Edit Profile">
                                <i class="fas fa-cog"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="table-footer">
        <p style="font-size: 13px; color: var(--text-muted);" id="paginationInfo">
            Displaying entries...
        </p>
        <div class="pagination" id="pagination">
            <!-- Dynamic Buttons -->
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('userSearch');
        const roleFilter = document.getElementById('roleFilter');
        const pageSizeSelect = document.getElementById('pageSize');
        const userRows = Array.from(document.querySelectorAll('.user-row'));
        const paginationContainer = document.getElementById('pagination');
        const paginationInfo = document.getElementById('paginationInfo');
        
        let currentPage = 1;
        let filteredRows = [...userRows];

        function updateTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedRole = roleFilter.value;
            const pageSize = parseInt(pageSizeSelect.value);

            filteredRows = userRows.filter(row => {
                const searchMatch = row.getAttribute('data-search').includes(searchTerm);
                const roleMatch = selectedRole === 'all' || row.getAttribute('data-role') === selectedRole;
                return searchMatch && roleMatch;
            });

            const totalPages = Math.ceil(filteredRows.length / pageSize);
            if (currentPage > totalPages) currentPage = Math.max(1, totalPages);

            const startIdx = (currentPage - 1) * pageSize;
            const endIdx = startIdx + pageSize;

            userRows.forEach(row => row.style.display = 'none');
            filteredRows.slice(startIdx, endIdx).forEach(row => row.style.display = '');

            updatePagination(totalPages, startIdx, endIdx);
        }

        function updatePagination(totalPages, start, end) {
            paginationContainer.innerHTML = '';
            
            const createBtn = (label, page, active = false, disabled = false) => {
                const btn = document.createElement('button');
                btn.className = `page-btn ${active ? 'active' : ''}`;
                btn.textContent = label;
                btn.disabled = disabled;
                btn.addEventListener('click', () => {
                    currentPage = page;
                    updateTable();
                });
                return btn;
            };

            paginationContainer.appendChild(createBtn('«', currentPage - 1, false, currentPage === 1));
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    paginationContainer.appendChild(createBtn(i, i, i === currentPage));
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.style.padding = '8px';
                    paginationContainer.appendChild(span);
                }
            }

            paginationContainer.appendChild(createBtn('»', currentPage + 1, false, currentPage === totalPages || totalPages === 0));

            const totalShown = Math.min(end, filteredRows.length);
            paginationInfo.textContent = filteredRows.length > 0 
                ? `Showing ${start + 1} to ${totalShown} of ${filteredRows.length} users`
                : `No users found`;
        }

        searchInput.addEventListener('input', () => { currentPage = 1; updateTable(); });
        roleFilter.addEventListener('change', () => { currentPage = 1; updateTable(); });
        pageSizeSelect.addEventListener('change', () => { currentPage = 1; updateTable(); });

        updateTable();
    });
</script>
{% endblock %}


