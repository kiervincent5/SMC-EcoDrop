{% extends 'core/base_dashboard.html' %}
{% load static %}

{% block title %}Rewards - EcoDrop{% endblock %}

{% block sidebar %}
<div class="nav-section">
    <div class="nav-label">Navigation</div>
    <ul class="nav-list">
        <li class="nav-item">
            <a href="{% if user.is_staff %}{% url 'teacher_dashboard' %}{% else %}{% url 'dashboard' %}{% endif %}">
                <i class="fas fa-th-large"></i> Dashboard
            </a>
        </li>
        <li class="nav-item">
            <a href="{% if user.is_staff %}{% url 'teacher_profile' %}{% else %}{% url 'student_profile' %}{% endif %}">
                <i class="fas fa-id-card"></i> Profile
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'rewards' %}" class="active">
                <i class="fas fa-gift"></i> Rewards Center
            </a>
        </li>
        <li class="nav-item">
            <a href="{% url 'redemption_history' %}">
                <i class="fas fa-history"></i> Claims History
            </a>
        </li>
    </ul>
</div>
{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{% static 'core/css/rewards.css' %}">
{% endblock %}

{% block content %}
<section class="like-panel">
    <div class="rewards-header">
        <i class="fas fa-gift"></i> Available Rewards
    </div>
    <div class="points-pill">
        You have <span class="points-num">{{ user_profile.total_points }} points</span> available
    </div>

    <!-- Search Bar -->
    <div class="search-bar">
        <form method="get" action="{% url 'rewards' %}">
            <input type="text" name="search" placeholder="Search rewards..." value="{{ search_query }}">
        </form>
    </div>

    {% if rewards %}
    <div class="rewards-grid">
        {% for reward in rewards %}
        <div class="reward-card">
            <div class="reward-header {% cycle 'green' 'blue' 'purple' '' %}">
                {% if reward.image %}
                <img src="{{ reward.image.url }}" alt="{{ reward.reward_name }}"
                    onerror="this.style.display='none'; this.parentElement.querySelector('.reward-icon').style.display='flex';">
                <div class="reward-icon" style="display:none;">
                    <i class="fas fa-gift"></i>
                </div>
                {% else %}
                <div class="reward-icon">
                    <i class="fas fa-gift"></i>
                </div>
                {% endif %}
                <div class="reward-name">{{ reward.reward_name }}</div>
            </div>
            <div class="reward-body">
                <div class="reward-meta">
                    <div class="reward-points">
                        <i class="fas fa-lock"></i> {{ reward.points_required }} pts required
                    </div>
                    {% if user_profile.total_points >= reward.points_required %}
                    <span class="status-badge">Available</span>
                    {% else %}
                    <span class="status-badge unavailable">Locked</span>
                    {% endif %}
                </div>
                {% if user_profile.total_points >= reward.points_required %}
                <button class="redeem-btn" data-reward-id="{{ reward.id }}" data-reward-name="{{ reward.reward_name }}"
                    data-reward-points="{{ reward.points_required }}"
                    data-reward-color="{% cycle 'beige' 'green' 'blue' 'purple' %}">
                    Redeem Now
                </button>
                {% else %}
                {% widthratio user_profile.total_points -1 1 as neg_points %}
                <button class="redeem-btn" disabled>Need {{ reward.points_required|add:neg_points }} more
                    points</button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p style="text-align: center; color: #666; padding: 40px;"><i class="fas fa-gift"></i> No rewards {% if search_query %}found for "{{ search_query }}"{% else %}available at the moment. Check back later!{% endif %}</p>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj.paginator.num_pages > 1 %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
            class="page-btn">Prev</a>
        {% else %}
        <span class="page-btn disabled">Prev</span>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        {% if page_obj.number == num %}
        <span class="page-btn active">{{ num }}</span>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %} <a
            href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}" class="page-btn">{{ num }}</a>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}"
                class="page-btn">Next</a>
            {% else %}
            <span class="page-btn disabled">Next</span>
            {% endif %}
    </div>
    {% endif %}
</section>

<section class="like-panel">
    <h2><i class="fas fa-lightbulb"></i> How to Earn More Points</h2>
    <ul class="tips">
        <li><i class="fas fa-bottle-water"></i> Deposit 1 bottle = 10 points</li>
        <li><i class="fas fa-seedling"></i> Help save the environment while earning rewards!</li>
    </ul>
</section>


    {% include 'core/includes/redemption_modal.html' %}
    {% include 'core/includes/success_modal.html' %}

    <script src="{% static 'core/js/rewards.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            RewardsManager.init('{{ user_profile.total_points }}');
        });
    </script>
{% endblock %}